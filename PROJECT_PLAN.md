# Telegram Subscription Bot - План разработки

## 📋 Обзор проекта

**Цель**: Создать гибкий Telegram бота для управления подписками с поддержкой различных платежных систем.

**Основные функции**:
- 💳 Управление подписками
- 🔄 Гибкая система ценообразования
- 👥 Автоматическое управление доступом к группам
- ⚙️ Простая интеграция платежных провайдеров
- 🌍 Поддержка нескольких валют

## 🗂️ Текущая структура проекта

```
pbot/
├── bot.py                    # Основной бот
├── bot_simple.py             # Упрощённая версия
├── db.py                     # База данных (SQLite)
├── config.py                 # Конфигурация
├── check_config.py           # Проверка конфигурации
├── check_aiogram.py          # Проверка aiogram
├── requirements.txt          # Зависимости
├── .env.example              # Пример переменных окружения
└── README.md                 # Документация
```

## 🎯 Этапы разработки

### Этап 1: Базовая функциональность ✅
**Статус**: Завершен
**Компоненты**:
- [x] Основной бот с Telegram
- [x] База данных подписок
- [x] Система проверки конфигурации
- [x] Демо-режим для тестирования

### Этап 2: Интеграция платежных систем
**Статус**: В разработке
**Задачи**:
- [ ] Интеграция платежного провайдера
- [ ] Обработка вебхуков платежей
- [ ] Управление методами оплаты
- [ ] История платежей в БД

### Этап 3: Управление подписками
**Статус**: Планируется
**Задачи**:
- [ ] Автоматическое продление подписок
- [ ] Система предупреждений перед истечением
- [ ] Управление скидками и промокодами
- [ ] Возврат платежей (рефунды)
- [ ] Админ-панель управления

### Этап 4: Контроль доступа к группам
**Статус**: Планируется
**Задачи**:
- [ ] Автоматическое добавление в группу
- [ ] Автоматическое исключение при истечении подписки
- [ ] Проверка статуса при входе в группу
- [ ] Система переподписок после возобновления

## 🔧 Технический стек

### Основные технологии
- **Bot Framework**: aiogram 3.x
- **Платежи**: Pluggable payment providers (demo mode по умолчанию)
- **База данных**: SQLite → PostgreSQL (для продакшена)
- **Веб-сервер**: aiohttp (для webhooks)

### Текущие зависимости
```
aiogram>=3.0.0
python-dotenv>=1.0.0
aiohttp>=3.8.5
```

## 📊 Структура базы данных

### Таблица users
```sql
CREATE TABLE users (
    telegram_id BIGINT PRIMARY KEY,
    username VARCHAR(255),
    first_name VARCHAR(255),
    last_name VARCHAR(255),
    
    -- Подписка
    subscription_active BOOLEAN DEFAULT FALSE,
    subscription_end_date DATETIME,
    subscription_type VARCHAR(50),
    tariff VARCHAR(50),
    
    -- Платежи
    payment_status VARCHAR(50),
    auto_renewal BOOLEAN DEFAULT FALSE,
    last_payment_date DATETIME,
    
    -- Система
    joined_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

## 📝 Конфигурация (.env)

```bash
# Telegram
TELEGRAM_API_TOKEN=your_bot_token
TELEGRAM_GROUP_ID=your_group_id
TELEGRAM_ADMIN_IDS=admin1,admin2

# Платежи
PAYMENT_PROVIDER=demo
PROVIDER_TOKEN=your_provider_token

# База данных
DATABASE_URL=sqlite:///bot_database.db

# Webhook (если требуется)
WEBHOOK_URL=https://your-domain.com/webhook
WEBHOOK_SECRET=your_webhook_secret
```

## ✅ TODO List по приоритетам

### Высокий приоритет
- [ ] Реализовать платежные провайдеры
- [ ] Настроить обработку вебхуков
- [ ] Протестировать платежи в тестовом режиме
- [ ] Добавить логирование платежей

### Средний приоритет
- [ ] Система управления подписками
- [ ] Админ-команды управления
- [ ] Автоматические напоминания
- [ ] Контроль доступа к группам

### Низкий приоритет
- [ ] Расширенная аналитика
- [ ] Админ-панель (веб)
- [ ] Многоязычная поддержка
- [ ] Экспорт статистики

## 💻 Локальная разработка

1. `git clone` проекта
2. Создание `.env` с настройками
3. `pip install -r requirements.txt`
4. `python bot.py`

## 🚀 Продакшен

- VPS/VDS сервер (Ubuntu 22.04+)
- Nginx для проксирования webhooks
- PostgreSQL вместо SQLite
- SSL сертификаты для webhooks
- Systemd service для автозапуска

## 📈 Метрики и аналитика

### Отслеживание
- Количество активных подписчиков
- Конверсия в платежи
- Средняя продолжительность подписки
- Статистика использования команд
- Частота ошибок

### Логирование
- Все платежи и их статусы
- Ошибки и исключения
- Добавления/удаления пользователей
- Изменения подписок

---

**Начать с**: Интеграция платежной системы (Этап 2)

**Приоритет**: Сначала настроить стабильные платежи, потом добавлять доп функции.

**Тестирование**: Использовать demo provider для разработки и тестирования перед интеграцией реальной платежной системы.

---

*Этот план будет обновляться по мере развития проекта. Сохраняйте этот файл актуальным.*
